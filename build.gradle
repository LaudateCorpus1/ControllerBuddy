plugins {
	id 'application'
	id 'com.github.spotbugs' version '4.6.0'
	id 'com.diffplug.gradle.spotless' version '3.27.2'
	id 'eclipse'
	id 'org.ajoberstar.grgit' version '4.1.0'
}

mainClassName = 'de.bwravencl.controllerbuddy.gui.Main'
version = "${org.ajoberstar.grgit.Grgit.open(dir: projectDir).describe(longDescr: true).replaceFirst(java.util.regex.Pattern.quote('-'), '.').replaceFirst(java.util.regex.Pattern.quote('-g'), '-')}"

sourceCompatibility = 15
targetCompatibility = 15

ext {
	versionWithoutHash = version.substring(0, version.indexOf('-'))

	jnaVersion = '5.5.0'
	lwjglVersion = '3.2.3'

	genDir = 'gen'
	versionDir = "$genDir/main/java"

	libsDir = "$buildDir/$libsDirName"
	tmpDir = "$buildDir/tmp"
	appImageDir = "$tmpDir/$project.name"
	runtimeDir = "$tmpDir/runtime"

	jdtUiPrefsFile = '.settings/org.eclipse.jdt.ui.prefs'
	spotbugsPrefsFile = '.settings/edu.umd.cs.findbugs.core.prefs'
}

repositories {
	mavenCentral()
	maven { url 'https://jitpack.io' }
}

dependencies {
	implementation 'commons-cli:commons-cli:1.4',
			'com.formdev:flatlaf:0.45',
			'com.github.nyholku:purejavahidapi:ef5679619d',
			'com.google.code.gson:gson:2.8.6',
			'io.github.classgraph:classgraph:4.8.95',
			"net.java.dev.jna:jna:$jnaVersion",
			"net.java.dev.jna:jna-platform:$jnaVersion",
			"org.lwjgl:lwjgl:$lwjglVersion",
			"org.lwjgl:lwjgl-glfw:$lwjglVersion",
			"org.lwjgl:lwjgl-opengl:$lwjglVersion",
			"org.lwjgl:lwjgl-openvr:$lwjglVersion"
	implementation	('org.apache.xmlgraphics:batik-swing:1.13') {
		exclude group: 'xml-apis', module: 'xml-apis'
	}
	runtimeOnly "org.lwjgl:lwjgl:$lwjglVersion:natives-linux",
			"org.lwjgl:lwjgl:$lwjglVersion:natives-macos",
			"org.lwjgl:lwjgl:$lwjglVersion:natives-windows",
			"org.lwjgl:lwjgl-glfw:$lwjglVersion:natives-linux",
			"org.lwjgl:lwjgl-glfw:$lwjglVersion:natives-macos",
			"org.lwjgl:lwjgl-glfw:$lwjglVersion:natives-windows",
			"org.lwjgl:lwjgl-opengl:$lwjglVersion:natives-windows",
			"org.lwjgl:lwjgl-openvr:$lwjglVersion:natives-windows"
}

spotbugs {
	effort = 'max'
	baselineFile = file("$projectDir/spotbugs-baseline.xml")
	reportLevel = 'low'
}

spotless {
	encoding 'UTF-8'
	java {
		target 'src/main/java/de/bwravencl/**/*.java'
		encoding 'Cp1252'
		eclipse().configFile 'spotless.eclipseformat.xml'
		importOrderFile 'spotless.importorder'
		licenseHeader '''\
			/* Copyright (C) $YEAR  Matteo Hausner
			 *
			 * This program is free software; you can redistribute it and/or modify
			 * it under the terms of the GNU General Public License as published by
			 * the Free Software Foundation; either version 2 of the License, or
			 * (at your option) any later version.
			 *
			 * This program is distributed in the hope that it will be useful,
			 * but WITHOUT ANY WARRANTY; without even the implied warranty of
			 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
			 * GNU General Public License for more details.
			 *
			 * You should have received a copy of the GNU General Public License along
			 * with this program; if not, write to the Free Software Foundation, Inc.,
			 * 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
			 */

			'''.stripIndent()
	}
	groovyGradle {
		target '*.gradle'
		greclipse().configFile('spotless.eclipseformat.xml')
	}
	format 'newlineAndTrailingWhitespace', {
		target '.github/workflows/*.yml', 'src/main/resources/**/*.properties', 'src/main/resources/**/*.svg'
		endWithNewline()
		trimTrailingWhitespace()
	}
	format 'onlyNewline', {
		target 'LICENSE', '*.gitignore', '*.importorder', '*.md', 'src/main/resources/**/*.txt', '*.txt', '*.xml'
		endWithNewline()
	}
}

jar.dependsOn check

task cleanGenDirectory {
	description = 'Removes the \'gen\' directory'
	doLast { delete genDir }
}

clean.dependsOn cleanGenDirectory

task generateVersion {
	description = 'Creates a source directory named \'gen\' and inside it generates a source file that defines a version string. Also removes any preexisting gen directory.'
	dependsOn cleanGenDirectory
	def outputDir = file("$versionDir")
	outputs.dir outputDir
	doLast {
		def srcFile = new File(outputDir, "de/bwravencl/controllerbuddy/version/Version.java")
		srcFile.parentFile.mkdirs()
		srcFile.write("""\
			package de.bwravencl.controllerbuddy.version;\n
			public class Version {

			\tpublic static final String VERSION = "$project.version";

			}
			""".stripIndent())
	}
}

task cleanJdtUiPrefs {
	description = 'Removes the \'org.eclipse.jdt.ui.prefs\' settings file'
	doLast { delete jdtUiPrefsFile, spotbugsPrefsFile }
}

tasks.cleanEclipse.dependsOn cleanJdtUiPrefs

tasks.eclipse.dependsOn generateVersion

eclipse {
	classpath {
		file {
			whenMerged { cp ->
				cp.entries.add(new org.gradle.plugins.ide.eclipse.model.SourceFolder("$versionDir", null) )
			}
		}
	}
	jdt {
		file {
			withProperties { properties ->
				new XmlParser().parse(file('spotless.eclipseformat.xml')).profile[0].'setting'.each {
					properties[it.'@id'] = it.'@value'
				}
			}
		}
	}
}

tasks.eclipse.doLast {
	def uiPrefs = file(jdtUiPrefsFile)
	if (uiPrefs.exists())
		logger.warn("UI preferences already exist and will not be overridden. Use task 'cleanEclipse' first.")
	else {
		uiPrefs.append('''\
			eclipse.preferences.version=1
			editor_save_participant_org.eclipse.jdt.ui.postsavelistener.cleanup=true
			formatter_settings_version=20
			sp_cleanup.add_default_serial_version_id=true
			sp_cleanup.add_generated_serial_version_id=false
			sp_cleanup.add_missing_annotations=true
			sp_cleanup.add_missing_deprecated_annotations=true
			sp_cleanup.add_missing_methods=false
			sp_cleanup.add_missing_nls_tags=false
			sp_cleanup.add_missing_override_annotations=true
			sp_cleanup.add_missing_override_annotations_interface_methods=true
			sp_cleanup.add_serial_version_id=false
			sp_cleanup.always_use_blocks=false
			sp_cleanup.always_use_parentheses_in_expressions=false
			sp_cleanup.always_use_this_for_non_static_field_access=false
			sp_cleanup.always_use_this_for_non_static_method_access=false
			sp_cleanup.convert_functional_interfaces=true
			sp_cleanup.convert_to_enhanced_for_loop=true
			sp_cleanup.convert_to_enhanced_for_loop_if_loop_var_used=false
			sp_cleanup.correct_indentation=true
			sp_cleanup.format_source_code=true
			sp_cleanup.format_source_code_changes_only=false
			sp_cleanup.insert_inferred_type_arguments=false
			sp_cleanup.lazy_logical_operator=true
			sp_cleanup.make_local_variable_final=true
			sp_cleanup.make_parameters_final=true
			sp_cleanup.make_private_fields_final=true
			sp_cleanup.make_type_abstract_if_missing_method=false
			sp_cleanup.make_variable_declarations_final=true
			sp_cleanup.merge_conditional_blocks=true
			sp_cleanup.never_use_blocks=true
			sp_cleanup.never_use_parentheses_in_expressions=true
			sp_cleanup.number_suffix=true
			sp_cleanup.objects_equals=true
			sp_cleanup.on_save_use_additional_actions=true
			sp_cleanup.organize_imports=true
			sp_cleanup.precompile_regex=true
			sp_cleanup.push_down_negation=true
			sp_cleanup.qualify_static_field_accesses_with_declaring_class=false
			sp_cleanup.qualify_static_member_accesses_through_instances_with_declaring_class=true
			sp_cleanup.qualify_static_member_accesses_through_subtypes_with_declaring_class=true
			sp_cleanup.qualify_static_member_accesses_with_declaring_class=true
			sp_cleanup.qualify_static_method_accesses_with_declaring_class=false
			sp_cleanup.remove_private_constructors=true
			sp_cleanup.remove_redundant_modifiers=true
			sp_cleanup.remove_redundant_semicolons=true
			sp_cleanup.remove_redundant_type_arguments=true
			sp_cleanup.remove_trailing_whitespaces=true
			sp_cleanup.remove_trailing_whitespaces_all=true
			sp_cleanup.remove_trailing_whitespaces_ignore_empty=false
			sp_cleanup.remove_unnecessary_array_creation=true
			sp_cleanup.remove_unnecessary_casts=true
			sp_cleanup.remove_unnecessary_nls_tags=true
			sp_cleanup.remove_unused_imports=true
			sp_cleanup.remove_unused_local_variables=false
			sp_cleanup.remove_unused_private_fields=true
			sp_cleanup.remove_unused_private_members=false
			sp_cleanup.remove_unused_private_methods=true
			sp_cleanup.remove_unused_private_types=true
			sp_cleanup.simplify_lambda_expression_and_method_ref=true
			sp_cleanup.sort_members=true
			sp_cleanup.sort_members_all=false
			sp_cleanup.use_anonymous_class_creation=false
			sp_cleanup.use_autoboxing=true
			sp_cleanup.use_blocks=true
			sp_cleanup.use_blocks_only_for_return_and_throw=false
			sp_cleanup.use_directly_map_method=true
			sp_cleanup.use_lambda=true
			sp_cleanup.use_parentheses_in_expressions=true
			sp_cleanup.use_this_for_non_static_field_access=true
			sp_cleanup.use_this_for_non_static_field_access_only_if_necessary=true
			sp_cleanup.use_this_for_non_static_method_access=true
			sp_cleanup.use_this_for_non_static_method_access_only_if_necessary=true
			sp_cleanup.use_unboxing=true
			sp_cleanup.use_var=true
			'''.stripIndent())
	}

	def spotbugsPrefs = file(spotbugsPrefsFile)
	if (spotbugsPrefs.exists())
		logger.warn("SpotBugs preferences already exist and will not be overridden. Use task 'cleanEclipse' first.")
	else {
		spotbugsPrefs.append('''\
			detectorExplicitSerialization=ExplicitSerialization|true
			detectorMultithreadedInstanceAccess=MultithreadedInstanceAccess|true
			detectorConfusionBetweenInheritedAndOuterMethod=ConfusionBetweenInheritedAndOuterMethod|true
			detectorWrongMapIterator=WrongMapIterator|true
			detectorUnnecessaryMath=UnnecessaryMath|true
			detectorUselessSubclassMethod=UselessSubclassMethod|false
			filter_settings=Low|BAD_PRACTICE,CORRECTNESS,EXPERIMENTAL,I18N,MALICIOUS_CODE,MT_CORRECTNESS,PERFORMANCE,SECURITY,STYLE|false|20
			detectorURLProblems=URLProblems|true
			detectorIteratorIdioms=IteratorIdioms|true
			detectorMutableEnum=MutableEnum|true
			detectorFindNonShortCircuit=FindNonShortCircuit|true
			detectorSynchronizeAndNullCheckField=SynchronizeAndNullCheckField|true
			detectorVolatileUsage=VolatileUsage|true
			detectorFindNakedNotify=FindNakedNotify|true
			detectorFindUninitializedGet=FindUninitializedGet|true
			detectorFindUseOfNonSerializableValue=FindUseOfNonSerializableValue|true
			detectorFindJSR166LockMonitorenter=FindJSR166LockMonitorenter|true
			detectorQuestionableBooleanAssignment=QuestionableBooleanAssignment|true
			detectorSwitchFallthrough=SwitchFallthrough|true
			detectorFindLocalSelfAssignment2=FindLocalSelfAssignment2|true
			detectorConfusedInheritance=ConfusedInheritance|true
			detectorSynchronizationOnSharedBuiltinConstant=SynchronizationOnSharedBuiltinConstant|true
			detectorMutableStaticFields=MutableStaticFields|true
			detectorInvalidJUnitTest=InvalidJUnitTest|true
			detectorInfiniteLoop=InfiniteLoop|true
			detectorFindRunInvocations=FindRunInvocations|true
			detectorBadSyntaxForRegularExpression=BadSyntaxForRegularExpression|true
			detectorXMLFactoryBypass=XMLFactoryBypass|true
			detectorFindOpenStream=FindOpenStream|true
			detectorCheckExpectedWarnings=CheckExpectedWarnings|false
			detectorHugeSharedStringConstants=HugeSharedStringConstants|true
			detectorLostLoggerDueToWeakReference=LostLoggerDueToWeakReference|true
			detectorStringConcatenation=StringConcatenation|true
			detectorLoadOfKnownNullValue=LoadOfKnownNullValue|true
			detectorFinalizerNullsFields=FinalizerNullsFields|true
			detectorFindFieldSelfAssignment=FindFieldSelfAssignment|true
			detectorInefficientToArray=InefficientToArray|false
			detectorDontCatchIllegalMonitorStateException=DontCatchIllegalMonitorStateException|true
			detectorInconsistentAnnotations=InconsistentAnnotations|true
			detectorBadlyOverriddenAdapter=BadlyOverriddenAdapter|true
			detectorInstantiateStaticClass=InstantiateStaticClass|true
			detectorCheckRelaxingNullnessAnnotation=CheckRelaxingNullnessAnnotation|true
			detectorMethodReturnCheck=MethodReturnCheck|true
			detectorEqualsOperandShouldHaveClassCompatibleWithThis=EqualsOperandShouldHaveClassCompatibleWithThis|true
			detectorFindDoubleCheck=FindDoubleCheck|true
			detectorFindBadForLoop=FindBadForLoop|true
			detectorDefaultEncodingDetector=DefaultEncodingDetector|true
			detectorFindInconsistentSync2=FindInconsistentSync2|true
			detectorFindSpinLoop=FindSpinLoop|true
			detectorFindMaskedFields=FindMaskedFields|true
			detectorBooleanReturnNull=BooleanReturnNull|true
			detectorFindUnsyncGet=FindUnsyncGet|true
			detectorCrossSiteScripting=CrossSiteScripting|true
			detectorDroppedException=DroppedException|true
			detectorFindDeadLocalStores=FindDeadLocalStores|true
			detectorCheckImmutableAnnotation=CheckImmutableAnnotation|true
			detectorInfiniteRecursiveLoop=InfiniteRecursiveLoop|true
			detectorFindRefComparison=FindRefComparison|true
			detectorFindRoughConstants=FindRoughConstants|true
			detectorMutableLock=MutableLock|true
			detectorFindNullDeref=FindNullDeref|true
			detectorFindReturnRef=FindReturnRef|true
			detectorSynchronizeOnClassLiteralNotGetClass=SynchronizeOnClassLiteralNotGetClass|true
			detectorFindUselessControlFlow=FindUselessControlFlow|true
			detectorOverridingEqualsNotSymmetrical=OverridingEqualsNotSymmetrical|true
			detectorIDivResultCastToDouble=IDivResultCastToDouble|true
			detectorReadOfInstanceFieldInMethodInvokedByConstructorInSuperclass=ReadOfInstanceFieldInMethodInvokedByConstructorInSuperclass|true
			detectorFindSelfComparison=FindSelfComparison|true
			detectorFindFloatEquality=FindFloatEquality|true
			detectorFindComparatorProblems=FindComparatorProblems|true
			detectorRepeatedConditionals=RepeatedConditionals|true
			filter_settings_neg=NOISE|
			detectorInefficientMemberAccess=InefficientMemberAccess|false
			detectorFindUncalledPrivateMethods=FindUncalledPrivateMethods|true
			detectorNumberConstructor=NumberConstructor|true
			detectorDontAssertInstanceofInTests=DontAssertInstanceofInTests|true
			detectorFindFinalizeInvocations=FindFinalizeInvocations|true
			detectorFindNullDerefsInvolvingNonShortCircuitEvaluation=FindNullDerefsInvolvingNonShortCircuitEvaluation|true
			detectorDontIgnoreResultOfPutIfAbsent=DontIgnoreResultOfPutIfAbsent|true
			detectorFindUnconditionalWait=FindUnconditionalWait|true
			detectorFindTwoLockWait=FindTwoLockWait|true
			detectorFindSleepWithLockHeld=FindSleepWithLockHeld|true
			detectorFindUnreleasedLock=FindUnreleasedLock|true
			detectorInefficientIndexOf=InefficientIndexOf|false
			detectorDoInsideDoPrivileged=DoInsideDoPrivileged|true
			detectorFindEmptySynchronizedBlock=FindEmptySynchronizedBlock|true
			detectorOverridingMethodsMustInvokeSuperDetector=OverridingMethodsMustInvokeSuperDetector|true
			detectorWaitInLoop=WaitInLoop|true
			detectorIntCast2LongAsInstant=IntCast2LongAsInstant|true
			detectorBadUseOfReturnValue=BadUseOfReturnValue|true
			detectorFindSqlInjection=FindSqlInjection|true
			detectorUnreadFields=UnreadFields|true
			detectorSynchronizingOnContentsOfFieldToProtectField=SynchronizingOnContentsOfFieldToProtectField|true
			detectorFindUselessObjects=FindUselessObjects|true
			detectorBadAppletConstructor=BadAppletConstructor|false
			excludebugs0=spotbugs-baseline.xml|true
			detectorInheritanceUnsafeGetResource=InheritanceUnsafeGetResource|true
			detectorSerializableIdiom=SerializableIdiom|true
			detectorNaming=Naming|true
			detectorNoteUnconditionalParamDerefs=NoteUnconditionalParamDerefs|true
			detectorFormatStringChecker=FormatStringChecker|true
			detectorSuspiciousThreadInterrupted=SuspiciousThreadInterrupted|true
			detectorEmptyZipFileEntry=EmptyZipFileEntry|false
			detectorFindCircularDependencies=FindCircularDependencies|false
			detectorPreferZeroLengthArrays=PreferZeroLengthArrays|true
			detectorAtomicityProblem=AtomicityProblem|true
			detectorRuntimeExceptionCapture=RuntimeExceptionCapture|true
			detectorInitializationChain=InitializationChain|true
			detectorInitializeNonnullFieldsInConstructor=InitializeNonnullFieldsInConstructor|true
			detectorOptionalReturnNull=OptionalReturnNull|true
			detectorStartInConstructor=StartInConstructor|true
			detectorFindUnsatisfiedObligation=FindUnsatisfiedObligation|true
			detectorRedundantConditions=RedundantConditions|true
			effort=max
			detectorRedundantInterfaces=RedundantInterfaces|true
			detectorDuplicateBranches=DuplicateBranches|true
			detectorCheckTypeQualifiers=CheckTypeQualifiers|true
			detectorComparatorIdiom=ComparatorIdiom|true
			detectorFindBadCast2=FindBadCast2|true
			detectorFindMismatchedWaitOrNotify=FindMismatchedWaitOrNotify|true
			detectorBadResultSetAccess=BadResultSetAccess|true
			detectorIncompatMask=IncompatMask|true
			detectorCovariantArrayAssignment=CovariantArrayAssignment|false
			detectorDumbMethodInvocations=DumbMethodInvocations|true
			run_at_full_build=false
			detectorStaticCalendarDetector=StaticCalendarDetector|true
			detectorUncallableMethodOfAnonymousClass=UncallableMethodOfAnonymousClass|true
			detectorVarArgsProblems=VarArgsProblems|true
			detectorInefficientInitializationInsideLoop=InefficientInitializationInsideLoop|false
			detectorCloneIdiom=CloneIdiom|true
			detectorFindHEmismatch=FindHEmismatch|true
			detectorAppendingToAnObjectOutputStream=AppendingToAnObjectOutputStream|true
			detectorFindSelfComparison2=FindSelfComparison2|true
			detectorLazyInit=LazyInit|true
			detectorFindUnrelatedTypesInGenericContainer=FindUnrelatedTypesInGenericContainer|true
			detectorDontUseEnum=DontUseEnum|true
			detectorFindPuzzlers=FindPuzzlers|true
			detectorCallToUnsupportedMethod=CallToUnsupportedMethod|false
			detectorSuperfluousInstanceOf=SuperfluousInstanceOf|true
			detectorReadReturnShouldBeChecked=ReadReturnShouldBeChecked|true
			detector_threshold=3
			detectorPublicSemaphores=PublicSemaphores|false
			detectorDumbMethods=DumbMethods|true
			'''.stripIndent())
	}
}

compileJava {
	dependsOn generateVersion
	source generateVersion.outputs.files, sourceSets.main.java
	options.compilerArgs += ["-Xlint:deprecation"]
}

task jlink(type: Exec) {
	description = 'Executes the jlink command to create a customized minimal Java runtime inside the build directory. Also removes any preexisting runtime in the same directory.'
	group
	doFirst { delete runtimeDir }
	commandLine 'jlink', '--output', "$runtimeDir", '--strip-debug', '--no-header-files', '--no-man-pages', '--strip-native-commands', '--add-modules', 'java.desktop,java.sql,jdk.unsupported,jdk.xml.dom'
}

task copyLibs(type: Copy) {
	description = 'Copies all jar files into a directory called \'libs\' inside the build directory.'
	dependsOn jar
	from configurations.runtimeClasspath
	into "$libsDir"
}

task customizeLoggingProperties {
	description = 'Alters the default "logging.properties" configuration file of the Java runtime to include a FileHandler that logs to a logfile in the system\'s TEMP directory using SimpleFormatter with custom formatting.'
	dependsOn jlink
	doLast {
		ant.propertyfile(file: "$runtimeDir/conf/logging.properties") {
			entry(key: 'handlers', value: 'java.util.logging.FileHandler, java.util.logging.ConsoleHandler')
			entry(key: 'java.util.logging.FileHandler.pattern', value: "%t/${project.name}.log")
			entry(key: 'java.util.logging.FileHandler.formatter', value: 'java.util.logging.SimpleFormatter')
			entry(key: 'java.util.logging.SimpleFormatter.format', value: '[%1$tY-%1$tm-%1$td %1$tk:%1$tM:%1$tS:%1$tL] %3$s: %5$s%6$s%n')
		}
	}
}

task jpackage(type: Exec) {
	description = 'Executes the jpackage command to create a standalone application image packaged with a custom minimal Java runtime.'
	dependsOn copyLibs, customizeLoggingProperties
	doFirst { delete "$appImageDir" }
	commandLine 'jpackage', '--input', "$libsDir", '--dest', "$tmpDir", '--type', 'app-image', '--name', "$project.name", '--runtime-image', "$runtimeDir", '--main-class', "$mainClassName", '--main-jar', "${project.name}-${version}.jar", '--app-version', "$versionWithoutHash", '--icon', "$projectDir/icon.ico", '--copyright', "Copyright ${new Date().format('yyyy')} Matteo Hausner", '--vendor', 'Matteo Hausner', '--verbose'
}

startScripts.enabled = false
distTar.enabled = false

task distZip(type: Zip, overwrite: true) {
	dependsOn jpackage
	from "$tmpDir"
	include "$project.name/**"
}

task installDist(type: Sync, overwrite: true) {
	dependsOn jpackage
	from "$tmpDir"
	into "$buildDir/install"
	include "$project.name/**"
}
